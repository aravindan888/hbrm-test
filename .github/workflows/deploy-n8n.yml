name: Deploy n8n

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.VM_SSH_KEY }}" ]; then echo "VM_SSH_KEY is not set"; exit 1; fi
          if [ -z "${{ secrets.VM_IP }}" ]; then echo "VM_IP is not set"; exit 1; fi
          if [ -z "${{ secrets.VM_USER }}" ]; then echo "VM_USER is not set"; exit 1; fi

      - name: Update Repository and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_IP }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            # Exit script on any error
            set -e

            PROJECT_DIR="$HOME/hbrm-test"
            cd "$PROJECT_DIR"

            echo "--- Updating repository ---"
            # Backup .env, force pull, and restore .env
            [ -f .env ] && cp .env .env.backup
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            [ -f .env.backup ] && mv .env.backup .env

            echo "--- Deploying n8n application ---"
            # The deploy script can now be simpler as it assumes Docker is ready
            # Ensure script is executable and run it
            chmod +x scripts/deploy_n8n.sh
            bash scripts/deploy_n8n.sh
